// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id          String    @id @default(cuid())
  username    String    @unique
  password    String
  role        String    @default("USER")  // "USER" or "ADMIN"
  pageAccess  String[]  @default(["dashboard", "employees", "all-entries", "employee-attendance"])
  lastLoginAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model Record {
  id                                   String    @id @default(cuid())
  createdAt                            DateTime  @default(now())
  updatedAt                            DateTime  @updatedAt
  status                               String    // "PENDING" or "COMPLETED"
  serialNo                             String?   // Format: Jan/05/001 (month/day/sequence)
  
  // Form fields
  dronaSupervisor                      String
  shift                                String    // "Day Shift" or "Night Shift"
  date                                 String?   // Date in YYYY-MM-DD format
  inTime                               String?   // In time in HH:MM format
  outTime                              String?   // Out time in HH:MM format
  srNoVehicleCount                     Int?      // Nullable until completed
  binNo                                String
  modelNo                              String
  chassisNo                            String
  type                                 String    // "PTS" or "PDI"
  
  // Manpower details (calculated from EmployeeAssignments)
  electrician                          Int       @default(0)
  fitter                               Int       @default(0)
  painter                              Int       @default(0)
  helper                               Int       @default(0)
  productionInchargeFromVBCL           String    @default("")
  
  // Other fields
  remarks                              String?
  completedAt                          DateTime? // For monthly counter logic
  deletedAt                            DateTime? // For soft delete (recycle bin)
  hours                                Float?    // Total hours (outTime - inTime) calculated on submit
  
  // Relations
  employeeAssignments                  EmployeeAssignment[]
}

model Employee {
  id                String               @id @default(cuid())
  employeeId        String               @unique // Format: DLPL/{E|F|P|H}/{number}
  name              String
  role              String               // "Electrician", "Fitter", "Painter", "Helper"
  isActive          Boolean              @default(true) // For active/deactive filter
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt
  
  // Relations
  attendances       EmployeeAttendance[]
  assignments       EmployeeAssignment[]
  
  @@unique([name, role])
}

model EmployeeAttendance {
  id          String   @id @default(cuid())
  employeeId  String
  date        String   // Date in YYYY-MM-DD format
  shift       String   // "Day" or "Night"
  createdAt   DateTime @default(now())
  
  // Relations
  employee    Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  
  @@unique([employeeId, date, shift])
  @@index([date, shift])
}

model EmployeeAssignment {
  id          String   @id @default(cuid())
  recordId    String
  employeeId  String
  splitCount  Float    @default(1.0) // Fractional count (e.g., 0.5 if used in 2 entries)
  createdAt   DateTime @default(now())
  
  // Relations
  record      Record   @relation(fields: [recordId], references: [id], onDelete: Cascade)
  employee    Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  
  @@unique([recordId, employeeId])
  @@index([employeeId])
  @@index([recordId])
}
